<!DOCTYPE html>
<html>
  <head>
    <title>Iframe Proxies Playground</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
      integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/a11y-light.min.css"
      integrity="sha512-WDk6RzwygsN9KecRHAfm9HTN87LQjqdygDmkHSJxVkVI7ErCZ8ZWxP6T8RvBujY1n2/E4Ac+bn2ChXnp5rnnHA=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <style>
      iframe {
        width: 320px;
        height: 100px;
        background-color: lightgray;
        border: 2px solid black;
        box-sizing: border-box;
      }
      #all-runs-container {
        height: 160px;
        background-color: grey;
        padding: 5px;
        overflow-y: auto;
        display: flex;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1 class="display-2">Iframe Proxies Playground</h1>
      <p class="lead">
        This project is a proof-of-concept of an idea about how to isolate sourceless/same-domain iframes with
        <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Proxy/revocable"
          >revokable proxies</a
        >.
      </p>
      <p>
        Compared with isolated/cross-domain iframes, sourceless iframes offer the ability to synchronously communicate
        with the main page with objects and functions. This power comes at the cost of increased chances for memory
        leaks because it enables inside-of-iframe code to become entangled with code outside the iframe.
      </p>
      <p>
        In this project, we are attempting to solve this problem by intercepting communication between iframe code and
        main window code with proxies. This enables us to cleanly break all retainers between the iframe and the main
        window when it is removed, which reduces the chances of a memory leak.
      </p>
      <p>
        To view the full code running on this page, see
        <a href="https://github.com/astegmaier/playground-hung-iframe-promise">this github repo</a>.
      </p>
      <div>
        <div>Note: in order for the "Collect Garbage" button to work, please run with flags: E.g.,:</div>
        <ul>
          <li>
            <b>PC:</b>
            <code>
              "C:\Program Files (x86)\Microsoft\Edge Beta\Application\msedge.exe" --js-flags="--expose-gc
              --enable-precise-memory-info"</code
            >
          </li>
          <li>
            <b>Mac:</b>
            <code>
              open -b com.microsoft.edgemac.Beta --args --js-flags="--expose-gc --enable-precise-memory-info"</code
            >
          </li>
        </ul>
        <div>
          You will need to quit any existing Edge/Chrome processes first via Task Manager before these flags take
          effect.
        </div>
      </div>
      <p>
        <div id="all-runs-container"></div>
      </p>
      <p>
        <label for="scenario">Scenario</label>
        <select id="scenario">
          <option value="1-leak-iframe-object">1 - Leak Iframe Object</option>
          <option value="2-leak-iframe">2 - Leak Iframe</option>
        </select>
        <button class="btn btn-primary" id="run-scenario">Add Iframe And Run Scenario</button>
        <button class="btn btn-secondary" id="remove-iframes">Remove All Iframes</button>
        <button class="btn btn-secondary" id="collect-garbage">Collect Garbage</button>
        <button class="btn btn-secondary" id="reset-scenario">Reset Scenario</button>
      </p>
      <div id="scenario-description"></div>
      <h2>Main Window Code</h2>
      <pre><code class="language-javascript" id="code"></code></pre>
      <h2>Iframe Code</h2>
      <pre><code class="language-javascript" id="code-iframe"></code></pre>
    </div>
    <script src="./index.js" type="module"></script>
  </body>
</html>
