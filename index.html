<!DOCTYPE html>
<html>
  <head>
    <title>Iframe Proxies Playground</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/a11y-light.min.css"
      integrity="sha512-WDk6RzwygsN9KecRHAfm9HTN87LQjqdygDmkHSJxVkVI7ErCZ8ZWxP6T8RvBujY1n2/E4Ac+bn2ChXnp5rnnHA=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"
      integrity="sha512-bgHRAiTjGrzHzLyKOnpFvaEpGzJet3z4tZnXGjpsCcqOnAH6VGUx9frc5bcIhKTVLEiCO6vEhNAgx5jtLUYrfA=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/marked/11.1.0/marked.min.js"
      integrity="sha512-49xmrP3uviO3RLWud0G4giZPhidSGQMjdsX3AkGH0tW4q1FN1nzTa4WGhyKIl+sggfI2q9rB78y/HvVK2HbVnA=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <style>
      iframe {
        width: 320px;
        height: 100px;
        background-color: lightgray;
        border: 2px solid black;
        box-sizing: border-box;
      }
      #iframe-container {
        height: 110px;
        background-color: grey;
        padding: 5px;
        overflow-y: auto;
      }
    </style>
  </head>
  <body>
    <h1>Iframe Proxies Playground</h1>
    <p>
      This project is a proof-of-concept of an idea about how to isolate
      sourceless/same-domain iframes with
      <a
        href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Proxy/revocable"
        >revokable proxies</a
      >.
    </p>
    <p>
      Compared with isolated/cross-domain iframes, sourceless iframes offer the
      ability to synchronously communicate with the main page with objects and
      functions. This power comes at the cost of increased chances for memory
      leaks because it enables inside-of-iframe code to become entangled with
      code outside the iframe.
    </p>
    <p>
      In this project, we are attempting to solve this problem by intercepting
      communication between iframe code and main window code with proxies. This
      enables us to cleanly break all retainers between the iframe and the main
      window when it is removed, which reduces the chances of a memory leak.
    </p>
    <p>To view the full code running on this page, see <a href="https://github.com/astegmaier/playground-hung-iframe-promise"
        >this github repo</a
      >.</p>
    <hr />
    <div>
      <div>
        Note: in order for the "Collect Garbage" button to work, please run with
        flags: E.g.,:
      </div>
      <pre style="white-space: break-spaces">
"C:\Program Files (x86)\Microsoft\Edge\Application\msedge.exe" --js-flags="--expose-gc --enable-precise-memory-info"</pre
      >
      <div>
        You will need to quit any existing Edge/Chrome processes first via Task
        Manager before these flags take effect.
      </div>
    </div>
    <hr />
    <div id="iframe-container"></div>
    <hr />
    <div>
      <label for="scenario">Scenario</label>
      <select id="scenario">
        <option value="1-leak-iframe-object">1 - Leak Iframe Object</option>
      </select>
      <button id="run-scenario">Add Iframe And Run Scenario</button>
      <button id="remove-iframes">Remove All Iframes</button>
      <button id="collect-garbage">Collect Garbage</button>
    </div>
    <div id="scenario-description"></div>
    <h2>Main Window Code</h2>
    <pre><code class="language-javascript" id="code"></code></pre>
    <h2>Iframe Code</h2>
    <pre><code class="language-javascript" id="code-iframe"></code></pre>
    <script src="./index.js"></script>
  </body>
</html>
